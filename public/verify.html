<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Email - PantherMarket</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>
</head>
<body>
    <header>
        <h1>PantherMarket</h1>
        <h3>A GSU Only Marketplace</h3>
    </header>
    <main>
        <div id="verification-content">
            <h2>Confirm You're Human</h2>
            <p>Please complete the check below to finalize your email verification.</p>
            
            <div class="g-recaptcha" data-callback="onRecaptchaSuccess" style="margin: 1.5rem auto; display: inline-block;"></div>
            
            <div id="recaptcha-container" class="g-recaptcha" style="margin: 1.5rem auto; display: inline-block;"></div>

            <button id="confirm-verification-btn" disabled>Confirm My Email</button>
            <p id="error-message" class="error"></p>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
        const confirmButton = document.getElementById('confirm-verification-btn');
        const errorMessage = document.getElementById('error-message');
        const verificationContent = document.getElementById('verification-content');
        let recaptchaToken = null;

        // This function is now called by Google's script when it's ready
        function onRecaptchaLoad() {
            // We'll render the widget manually once we have the site key
            if (window.siteKey) {
                renderRecaptcha();
            }
        }

        // This function will be called by the reCAPTCHA widget when solved
        function onRecaptchaSuccess(token) {
            recaptchaToken = token;
            confirmButton.disabled = false;
        }

        // This function will force-refresh the token until the custom claim appears.
        async function waitForClaims(auth) {
            // Wait for the auth state to be loaded
            const user = await new Promise((resolve, reject) => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    unsubscribe();
                    if (user) {
                        resolve(user);
                    } else {
                        // This case should ideally not be hit if they just registered,
                        // but it's good to have.
                        reject(new Error("You must be logged in to verify."));
                    }
                }, reject);
            });

            // Try up to 10 times (20 seconds total)
            for (let i = 0; i < 10; i++) {
                await new Promise(resolve => setTimeout(resolve, 2000)); // 2-second delay
                
                const tokenResult = await user.getIdTokenResult(true); // Force refresh
                
                if (tokenResult.claims.manuallyVerified === true) {
                    return true; // Claims are ready!
                }
                // If not, the loop continues and tries again
            }
            
            // If we exit the loop, it timed out
            throw new Error("Verification is taking longer than usual. Please refresh and try again.");
        }
        
        // This function calls our secure API endpoint
        async function verifyWithApi(oobCode) {
            // ... (This function remains the same as before)
            confirmButton.disabled = true;
            confirmButton.textContent = 'Verifying...';
            errorMessage.textContent = '';
            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ oobCode, recaptchaToken }),
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Verification failed.');

                confirmButton.textContent = 'Finalizing...';
                await waitForClaims(window.auth);

                verificationContent.innerHTML = `
                    <h2>Email Verified!</h2>
                    <p>Thank you! Your email has been successfully verified.</p>
                    <a href="/" style="text-decoration: none;"><button>Go to PantherMarket</button></a>
                `;
            } catch (error) {
                errorMessage.textContent = error.message;
                confirmButton.disabled = false;
                confirmButton.textContent = 'Confirm My Email';
                if (typeof grecaptcha !== 'undefined') {
                    grecaptcha.reset(); // Reset reCAPTCHA on failure
                }
            }
        }
        
        // NEW function to explicitly render the widget
        function renderRecaptcha() {
             grecaptcha.render('recaptcha-container', {
                'sitekey': window.siteKey,
                'callback': onRecaptchaSuccess
            });
        }

        // The main initialization function
        async function initialize() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                const { recaptchaSiteKey, ...firebaseConfig } = config;
                
                window.siteKey = recaptchaSiteKey; // Store the key globally

                firebase.initializeApp(firebaseConfig);
                window.auth = firebase.auth();

                // If reCAPTCHA script is already loaded, render it.
                // Otherwise, onRecaptchaLoad() will handle it.
                if (typeof grecaptcha !== 'undefined' && grecaptcha.render) {
                    renderRecaptcha();
                }

                const urlParams = new URLSearchParams(window.location.search);
                const actionCode = urlParams.get('oobCode');
                if (!actionCode) {
                    verificationContent.innerHTML = '<h2>Error</h2><p>Invalid verification link.</p>';
                    return;
                }
                confirmButton.addEventListener('click', () => {
                    if (recaptchaToken) verifyWithApi(actionCode);
                });

            } catch (error) {
                console.error("Initialization Error:", error);
                verificationContent.innerHTML = '<h2>Error</h2><p>Could not load application configuration.</p>';
            }
        }
        initialize();
    </script>
</body>
</html>